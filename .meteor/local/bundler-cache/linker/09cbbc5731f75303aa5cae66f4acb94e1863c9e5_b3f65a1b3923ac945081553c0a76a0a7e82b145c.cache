[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar FS = Package['cfs:base-package'].FS;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\nvar DDP = Package['ddp-client'].DDP;\nvar DDPServer = Package['ddp-server'].DDPServer;\nvar EJSON = Package.ejson.EJSON;\nvar EventEmitter = Package['raix:eventemitter'].EventEmitter;\nvar MongoInternals = Package.mongo.MongoInternals;\nvar Mongo = Package.mongo.Mongo;\n\n/* Package-scope variables */\nvar _storageAdapters;\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                                     //\n// packages/cfs_storage-adapter/packages/cfs_storage-adapter.js                                                        //\n//                                                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                       //\n(function () {\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cfs:storage-adapter/storageAdapter.server.js                                                         //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/* global FS, _storageAdapters:true, EventEmitter */                                                             // 1\n                                                                                                                 // 2\n// #############################################################################                                 // 3\n//                                                                                                               // 4\n// STORAGE ADAPTER                                                                                               // 5\n//                                                                                                               // 6\n// #############################################################################                                 // 7\n_storageAdapters = {};                                                                                           // 8\n                                                                                                                 // 9\nFS.StorageAdapter = function(storeName, options, api) {                                                          // 10\n  var self = this, fileKeyMaker;                                                                                 // 11\n  options = options || {};                                                                                       // 12\n                                                                                                                 // 13\n  // If storeName is the only argument, a string and the SA already found                                        // 14\n  // we will just return that SA                                                                                 // 15\n  if (arguments.length === 1 && storeName === '' + storeName &&                                                  // 16\n          typeof _storageAdapters[storeName] !== 'undefined')                                                    // 17\n    return _storageAdapters[storeName];                                                                          // 18\n                                                                                                                 // 19\n  // Verify that the storage adapter defines all the necessary API methods                                       // 20\n  if (typeof api === 'undefined') {                                                                              // 21\n    throw new Error('FS.StorageAdapter please define an api');                                                   // 22\n  }                                                                                                              // 23\n                                                                                                                 // 24\n  FS.Utility.each('fileKey,remove,typeName,createReadStream,createWriteStream'.split(','), function(name) {      // 25\n    if (typeof api[name] === 'undefined') {                                                                      // 26\n      throw new Error('FS.StorageAdapter please define an api. \"' + name + '\" ' + (api.typeName || ''));         // 27\n    }                                                                                                            // 28\n  });                                                                                                            // 29\n                                                                                                                 // 30\n  // Create an internal namespace, starting a name with underscore is only                                       // 31\n  // allowed for stores marked with options.internal === true                                                    // 32\n  if (options.internal !== true && storeName[0] === '_') {                                                       // 33\n    throw new Error('A storage adapter name may not begin with \"_\"');                                            // 34\n  }                                                                                                              // 35\n                                                                                                                 // 36\n  if (storeName.indexOf('.') !== -1) {                                                                           // 37\n    throw new Error('A storage adapter name may not contain a \".\"');                                             // 38\n  }                                                                                                              // 39\n                                                                                                                 // 40\n  // store reference for easy lookup by storeName                                                                // 41\n  if (typeof _storageAdapters[storeName] !== 'undefined') {                                                      // 42\n    throw new Error('Storage name already exists: \"' + storeName + '\"');                                         // 43\n  } else {                                                                                                       // 44\n    _storageAdapters[storeName] = self;                                                                          // 45\n  }                                                                                                              // 46\n                                                                                                                 // 47\n  // User can customize the file key generation function                                                         // 48\n  if (typeof options.fileKeyMaker === \"function\") {                                                              // 49\n    fileKeyMaker = options.fileKeyMaker;                                                                         // 50\n  } else {                                                                                                       // 51\n    fileKeyMaker = api.fileKey;                                                                                  // 52\n  }                                                                                                              // 53\n                                                                                                                 // 54\n  // User can provide a function to adjust the fileObj                                                           // 55\n  // before it is written to the store.                                                                          // 56\n  var beforeWrite = options.beforeWrite;                                                                         // 57\n                                                                                                                 // 58\n  // extend self with options and other info                                                                     // 59\n  FS.Utility.extend(this, options, {                                                                             // 60\n    name: storeName,                                                                                             // 61\n    typeName: api.typeName                                                                                       // 62\n  });                                                                                                            // 63\n                                                                                                                 // 64\n  // Create a nicer abstracted adapter interface                                                                 // 65\n  self.adapter = {};                                                                                             // 66\n                                                                                                                 // 67\n  self.adapter.fileKey = function(fileObj) {                                                                     // 68\n    return fileKeyMaker(fileObj);                                                                                // 69\n  };                                                                                                             // 70\n                                                                                                                 // 71\n  // Return readable stream for fileKey                                                                          // 72\n  self.adapter.createReadStreamForFileKey = function(fileKey, options) {                                         // 73\n    if (FS.debug) console.log('createReadStreamForFileKey ' + storeName);                                        // 74\n    return FS.Utility.safeStream( api.createReadStream(fileKey, options) );                                      // 75\n  };                                                                                                             // 76\n                                                                                                                 // 77\n  // Return readable stream for fileObj                                                                          // 78\n  self.adapter.createReadStream = function(fileObj, options) {                                                   // 79\n    if (FS.debug) console.log('createReadStream ' + storeName);                                                  // 80\n    if (self.internal) {                                                                                         // 81\n      // Internal stores take a fileKey                                                                          // 82\n      return self.adapter.createReadStreamForFileKey(fileObj, options);                                          // 83\n    }                                                                                                            // 84\n    return FS.Utility.safeStream( self._transform.createReadStream(fileObj, options) );                          // 85\n  };                                                                                                             // 86\n                                                                                                                 // 87\n  function logEventsForStream(stream) {                                                                          // 88\n    if (FS.debug) {                                                                                              // 89\n      stream.on('stored', function() {                                                                           // 90\n        console.log('-----------STORED STREAM', storeName);                                                      // 91\n      });                                                                                                        // 92\n                                                                                                                 // 93\n      stream.on('close', function() {                                                                            // 94\n        console.log('-----------CLOSE STREAM', storeName);                                                       // 95\n      });                                                                                                        // 96\n                                                                                                                 // 97\n      stream.on('end', function() {                                                                              // 98\n        console.log('-----------END STREAM', storeName);                                                         // 99\n      });                                                                                                        // 100\n                                                                                                                 // 101\n      stream.on('finish', function() {                                                                           // 102\n        console.log('-----------FINISH STREAM', storeName);                                                      // 103\n      });                                                                                                        // 104\n                                                                                                                 // 105\n      stream.on('error', function(error) {                                                                       // 106\n        console.log('-----------ERROR STREAM', storeName, error && (error.message || error.code));               // 107\n      });                                                                                                        // 108\n    }                                                                                                            // 109\n  }                                                                                                              // 110\n                                                                                                                 // 111\n  // Return writeable stream for fileKey                                                                         // 112\n  self.adapter.createWriteStreamForFileKey = function(fileKey, options) {                                        // 113\n    if (FS.debug) console.log('createWriteStreamForFileKey ' + storeName);                                       // 114\n    var writeStream = FS.Utility.safeStream( api.createWriteStream(fileKey, options) );                          // 115\n                                                                                                                 // 116\n    logEventsForStream(writeStream);                                                                             // 117\n                                                                                                                 // 118\n    return writeStream;                                                                                          // 119\n  };                                                                                                             // 120\n                                                                                                                 // 121\n  // Return writeable stream for fileObj                                                                         // 122\n  self.adapter.createWriteStream = function(fileObj, options) {                                                  // 123\n    if (FS.debug) console.log('createWriteStream ' + storeName + ', internal: ' + !!self.internal);              // 124\n                                                                                                                 // 125\n    if (self.internal) {                                                                                         // 126\n      // Internal stores take a fileKey                                                                          // 127\n      return self.adapter.createWriteStreamForFileKey(fileObj, options);                                         // 128\n    }                                                                                                            // 129\n                                                                                                                 // 130\n    // If we haven't set name, type, or size for this version yet,                                               // 131\n    // set it to same values as original version. We don't save                                                  // 132\n    // these to the DB right away because they might be changed                                                  // 133\n    // in a transformWrite function.                                                                             // 134\n    if (!fileObj.name({store: storeName})) {                                                                     // 135\n      fileObj.name(fileObj.name(), {store: storeName, save: false});                                             // 136\n    }                                                                                                            // 137\n    if (!fileObj.type({store: storeName})) {                                                                     // 138\n      fileObj.type(fileObj.type(), {store: storeName, save: false});                                             // 139\n    }                                                                                                            // 140\n    if (!fileObj.size({store: storeName})) {                                                                     // 141\n      fileObj.size(fileObj.size(), {store: storeName, save: false});                                             // 142\n    }                                                                                                            // 143\n                                                                                                                 // 144\n    // Call user function to adjust file metadata for this store.                                                // 145\n    // We support updating name, extension, and/or type based on                                                 // 146\n    // info returned in an object. Or `fileObj` could be                                                         // 147\n    // altered directly within the beforeWrite function.                                                         // 148\n    if (beforeWrite) {                                                                                           // 149\n      var fileChanges = beforeWrite(fileObj);                                                                    // 150\n      if (typeof fileChanges === \"object\") {                                                                     // 151\n        if (fileChanges.extension) {                                                                             // 152\n          fileObj.extension(fileChanges.extension, {store: storeName, save: false});                             // 153\n        } else if (fileChanges.name) {                                                                           // 154\n          fileObj.name(fileChanges.name, {store: storeName, save: false});                                       // 155\n        }                                                                                                        // 156\n        if (fileChanges.type) {                                                                                  // 157\n          fileObj.type(fileChanges.type, {store: storeName, save: false});                                       // 158\n        }                                                                                                        // 159\n      }                                                                                                          // 160\n    }                                                                                                            // 161\n                                                                                                                 // 162\n    var writeStream = FS.Utility.safeStream( self._transform.createWriteStream(fileObj, options) );              // 163\n                                                                                                                 // 164\n    logEventsForStream(writeStream);                                                                             // 165\n                                                                                                                 // 166\n    // Its really only the storage adapter who knows if the file is uploaded                                     // 167\n    //                                                                                                           // 168\n    // We have to use our own event making sure the storage process is completed                                 // 169\n    // this is mainly                                                                                            // 170\n    writeStream.safeOn('stored', function(result) {                                                              // 171\n      if (typeof result.fileKey === 'undefined') {                                                               // 172\n        throw new Error('SA ' + storeName + ' type ' + api.typeName + ' did not return a fileKey');              // 173\n      }                                                                                                          // 174\n      if (FS.debug) console.log('SA', storeName, 'stored', result.fileKey);                                      // 175\n      // Set the fileKey                                                                                         // 176\n      fileObj.copies[storeName].key = result.fileKey;                                                            // 177\n                                                                                                                 // 178\n      // Update the size, as provided by the SA, in case it was changed by stream transformation                 // 179\n      if (typeof result.size === \"number\") {                                                                     // 180\n        fileObj.copies[storeName].size = result.size;                                                            // 181\n      }                                                                                                          // 182\n                                                                                                                 // 183\n      // Set last updated time, either provided by SA or now                                                     // 184\n      fileObj.copies[storeName].updatedAt = result.storedAt || new Date();                                       // 185\n                                                                                                                 // 186\n      // If the file object copy havent got a createdAt then set this                                            // 187\n      if (typeof fileObj.copies[storeName].createdAt === 'undefined') {                                          // 188\n        fileObj.copies[storeName].createdAt = fileObj.copies[storeName].updatedAt;                               // 189\n      }                                                                                                          // 190\n                                                                                                                 // 191\n      fileObj._saveChanges(storeName);                                                                           // 192\n                                                                                                                 // 193\n      // There is code in transform that may have set the original file size, too.                               // 194\n      fileObj._saveChanges('_original');                                                                         // 195\n    });                                                                                                          // 196\n                                                                                                                 // 197\n    // Emit events from SA                                                                                       // 198\n    writeStream.once('stored', function(/*result*/) {                                                            // 199\n      // XXX Because of the way stores inherit from SA, this will emit on every store.                           // 200\n      // Maybe need to rewrite the way we inherit from SA?                                                       // 201\n      var emitted = self.emit('stored', storeName, fileObj);                                                     // 202\n      if (FS.debug && !emitted) {                                                                                // 203\n        console.log(fileObj.name() + ' was successfully stored in the ' + storeName + ' store. You are seeing this informational message because you enabled debugging and you have not defined any listeners for the \"stored\" event on this store.');\n      }                                                                                                          // 205\n    });                                                                                                          // 206\n                                                                                                                 // 207\n    writeStream.on('error', function(error) {                                                                    // 208\n      // XXX We could wrap and clarify error                                                                     // 209\n      // XXX Because of the way stores inherit from SA, this will emit on every store.                           // 210\n      // Maybe need to rewrite the way we inherit from SA?                                                       // 211\n      var emitted = self.emit('error', storeName, error, fileObj);                                               // 212\n      if (FS.debug && !emitted) {                                                                                // 213\n        console.log(error);                                                                                      // 214\n      }                                                                                                          // 215\n    });                                                                                                          // 216\n                                                                                                                 // 217\n    return writeStream;                                                                                          // 218\n  };                                                                                                             // 219\n                                                                                                                 // 220\n  //internal                                                                                                     // 221\n  self._removeAsync = function(fileKey, callback) {                                                              // 222\n    // Remove the file from the store                                                                            // 223\n    api.remove.call(self, fileKey, callback);                                                                    // 224\n  };                                                                                                             // 225\n                                                                                                                 // 226\n  /**                                                                                                            // 227\n   * @method FS.StorageAdapter.prototype.remove                                                                  // 228\n   * @public                                                                                                     // 229\n   * @param {FS.File} fsFile The FS.File instance to be stored.                                                  // 230\n   * @param {Function} [callback] If not provided, will block and return true or false                           // 231\n   *                                                                                                             // 232\n   * Attempts to remove a file from the store. Returns true if removed or not                                    // 233\n   * found, or false if the file couldn't be removed.                                                            // 234\n   */                                                                                                            // 235\n  self.adapter.remove = function(fileObj, callback) {                                                            // 236\n    if (FS.debug) console.log(\"---SA REMOVE\");                                                                   // 237\n                                                                                                                 // 238\n    // Get the fileKey                                                                                           // 239\n    var fileKey = (fileObj instanceof FS.File) ? self.adapter.fileKey(fileObj) : fileObj;                        // 240\n                                                                                                                 // 241\n    if (callback) {                                                                                              // 242\n      return self._removeAsync(fileKey, FS.Utility.safeCallback(callback));                                      // 243\n    } else {                                                                                                     // 244\n      return Meteor.wrapAsync(self._removeAsync)(fileKey);                                                       // 245\n    }                                                                                                            // 246\n  };                                                                                                             // 247\n                                                                                                                 // 248\n  self.remove = function(fileObj, callback) {                                                                    // 249\n    // Add deprecation note                                                                                      // 250\n    console.warn('Storage.remove is deprecating, use \"Storage.adapter.remove\"');                                 // 251\n    return self.adapter.remove(fileObj, callback);                                                               // 252\n  };                                                                                                             // 253\n                                                                                                                 // 254\n  if (typeof api.init === 'function') {                                                                          // 255\n    Meteor.wrapAsync(api.init.bind(self))();                                                                     // 256\n  }                                                                                                              // 257\n                                                                                                                 // 258\n  // This supports optional transformWrite and transformRead                                                     // 259\n  self._transform = new FS.Transform({                                                                           // 260\n    adapter: self.adapter,                                                                                       // 261\n    // Optional transformation functions:                                                                        // 262\n    transformWrite: options.transformWrite,                                                                      // 263\n    transformRead: options.transformRead                                                                         // 264\n  });                                                                                                            // 265\n                                                                                                                 // 266\n};                                                                                                               // 267\n                                                                                                                 // 268\nNpm.require('util').inherits(FS.StorageAdapter, EventEmitter);                                                   // 269\n                                                                                                                 // 270\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function () {\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                               //\n// packages/cfs:storage-adapter/transform.server.js                                                              //\n//                                                                                                               //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                                 //\n/* global FS, gm */                                                                                              // 1\n                                                                                                                 // 2\nvar PassThrough = Npm.require('stream').PassThrough;                                                             // 3\nvar lengthStream = Npm.require('length-stream');                                                                 // 4\n                                                                                                                 // 5\nFS.Transform = function(options) {                                                                               // 6\n  var self = this;                                                                                               // 7\n                                                                                                                 // 8\n  options = options || {};                                                                                       // 9\n                                                                                                                 // 10\n  if (!(self instanceof FS.Transform))                                                                           // 11\n    throw new Error('FS.Transform must be called with the \"new\" keyword');                                       // 12\n                                                                                                                 // 13\n  if (!options.adapter)                                                                                          // 14\n    throw new Error('Transform expects option.adapter to be a storage adapter');                                 // 15\n                                                                                                                 // 16\n  self.storage = options.adapter;                                                                                // 17\n                                                                                                                 // 18\n  // Fetch the transformation functions if any                                                                   // 19\n  self.transformWrite = options.transformWrite;                                                                  // 20\n  self.transformRead = options.transformRead;                                                                    // 21\n};                                                                                                               // 22\n                                                                                                                 // 23\n// Allow packages to add scope                                                                                   // 24\nFS.Transform.scope = {                                                                                           // 25\n// Deprecate gm scope:                                                                                           // 26\n  gm: function(source, height, color) {                                                                          // 27\n    console.warn('Deprecation notice: `this.gm` is deprecating in favour of the general global `gm` scope');     // 28\n    if (typeof gm !== 'function')                                                                                // 29\n      throw new Error('No graphicsmagick package installed, `gm` not found in scope, eg. `cfs-graphicsmagick`'); // 30\n    return gm(source, height, color);                                                                            // 31\n  }                                                                                                              // 32\n// EO Deprecate gm scope                                                                                         // 33\n};                                                                                                               // 34\n                                                                                                                 // 35\n// The transformation stream triggers an \"stored\" event when data is stored into                                 // 36\n// the storage adapter                                                                                           // 37\nFS.Transform.prototype.createWriteStream = function(fileObj) {                                                   // 38\n  var self = this;                                                                                               // 39\n                                                                                                                 // 40\n  // Get the file key                                                                                            // 41\n  var fileKey = self.storage.fileKey(fileObj);                                                                   // 42\n                                                                                                                 // 43\n  // Rig write stream                                                                                            // 44\n  var destinationStream = self.storage.createWriteStreamForFileKey(fileKey, {                                    // 45\n    // Not all SA's can set these options and cfs dont depend on setting these                                   // 46\n    // but its nice if other systems are accessing the SA that some of the data                                  // 47\n    // is also available to those                                                                                // 48\n    aliases: [fileObj.name()],                                                                                   // 49\n    contentType: fileObj.type(),                                                                                 // 50\n    metadata: fileObj.metadata                                                                                   // 51\n  });                                                                                                            // 52\n                                                                                                                 // 53\n  // Pass through transformWrite function if provided                                                            // 54\n  if (typeof self.transformWrite === 'function') {                                                               // 55\n                                                                                                                 // 56\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {                  // 57\n      // Rig transform                                                                                           // 58\n      try {                                                                                                      // 59\n        self.transformWrite.call(FS.Transform.scope, fileObj, ptStream, originalStream);                         // 60\n        // XXX: If the transform function returns a buffer should we stream that?                                // 61\n      } catch(err) {                                                                                             // 62\n        // We emit an error - should we throw an error?                                                          // 63\n        console.warn('FS.Transform.createWriteStream transform function failed, Error: ');                       // 64\n        throw err;                                                                                               // 65\n      }                                                                                                          // 66\n    });                                                                                                          // 67\n                                                                                                                 // 68\n  }                                                                                                              // 69\n                                                                                                                 // 70\n  // If original doesn't have size, add another PassThrough to get and set the size.                             // 71\n  // This will run on size=0, too, which is OK.                                                                  // 72\n  // NOTE: This must come AFTER the transformWrite code block above. This might seem                             // 73\n  // confusing, but by coming after it, this will actually be executed BEFORE the user's                         // 74\n  // transform, which is what we need in order to be sure we get the original file                               // 75\n  // size and not the transformed file size.                                                                     // 76\n  if (!fileObj.size()) {                                                                                         // 77\n    destinationStream = addPassThrough(destinationStream, function (ptStream, originalStream) {                  // 78\n      var lstream = lengthStream(function (fileSize) {                                                           // 79\n        fileObj.size(fileSize, {save: false});                                                                   // 80\n      });                                                                                                        // 81\n                                                                                                                 // 82\n      ptStream.pipe(lstream).pipe(originalStream);                                                               // 83\n    });                                                                                                          // 84\n  }                                                                                                              // 85\n                                                                                                                 // 86\n  return destinationStream;                                                                                      // 87\n};                                                                                                               // 88\n                                                                                                                 // 89\nFS.Transform.prototype.createReadStream = function(fileObj, options) {                                           // 90\n  var self = this;                                                                                               // 91\n                                                                                                                 // 92\n  // Get the file key                                                                                            // 93\n  var fileKey = self.storage.fileKey(fileObj);                                                                   // 94\n                                                                                                                 // 95\n  // Rig read stream                                                                                             // 96\n  var sourceStream = self.storage.createReadStreamForFileKey(fileKey, options);                                  // 97\n                                                                                                                 // 98\n  // Pass through transformRead function if provided                                                             // 99\n  if (typeof self.transformRead === 'function') {                                                                // 100\n                                                                                                                 // 101\n    sourceStream = addPassThrough(sourceStream, function (ptStream, originalStream) {                            // 102\n      // Rig transform                                                                                           // 103\n      try {                                                                                                      // 104\n        self.transformRead.call(FS.Transform.scope, fileObj, originalStream, ptStream);                          // 105\n      } catch(err) {                                                                                             // 106\n        //throw new Error(err);                                                                                  // 107\n        // We emit an error - should we throw an error?                                                          // 108\n        sourceStream.emit('error', 'FS.Transform.createReadStream transform function failed');                   // 109\n      }                                                                                                          // 110\n    });                                                                                                          // 111\n                                                                                                                 // 112\n  }                                                                                                              // 113\n                                                                                                                 // 114\n  // We dont transform just normal SA interface                                                                  // 115\n  return sourceStream;                                                                                           // 116\n};                                                                                                               // 117\n                                                                                                                 // 118\n// Utility function to simplify adding layers of passthrough                                                     // 119\nfunction addPassThrough(stream, func) {                                                                          // 120\n  var pts = new PassThrough();                                                                                   // 121\n  // We pass on the special \"stored\" event for those listening                                                   // 122\n  stream.on('stored', function(result) {                                                                         // 123\n    pts.emit('stored', result);                                                                                  // 124\n  });                                                                                                            // 125\n  func(pts, stream);                                                                                             // 126\n  return pts;                                                                                                    // 127\n}                                                                                                                // 128\n                                                                                                                 // 129\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\nPackage['cfs:storage-adapter'] = {};\n\n})();\n","servePath":"/packages/cfs_storage-adapter.js"}]