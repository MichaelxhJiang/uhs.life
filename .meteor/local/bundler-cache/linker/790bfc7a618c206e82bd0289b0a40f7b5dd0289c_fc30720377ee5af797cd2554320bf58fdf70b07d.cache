[{"type":"js","data":"//////////////////////////////////////////////////////////////////////////\n//                                                                      //\n// This is a generated file. You can view the original                  //\n// source in your browser if your browser supports source maps.         //\n// Source maps are supported by all recent versions of Chrome, Safari,  //\n// and Firefox, and by Internet Explorer 11.                            //\n//                                                                      //\n//////////////////////////////////////////////////////////////////////////\n\n\n(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar global = Package.meteor.global;\nvar meteorEnv = Package.meteor.meteorEnv;\nvar _ = Package.underscore._;\nvar Accounts = Package['accounts-base'].Accounts;\nvar Tracker = Package.tracker.Tracker;\nvar Deps = Package.tracker.Deps;\nvar Mongo = Package.mongo.Mongo;\nvar check = Package.check.check;\nvar Match = Package.check.Match;\n\n/* Package-scope variables */\nvar Roles;\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                         //\n// packages/alanning_roles/roles_common.js                                                                 //\n//                                                                                                         //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                           //\n;(function () {                                                                                            // 1\n                                                                                                           // 2\n/**                                                                                                        // 3\n * Provides functions related to user authorization. Compatible with built-in Meteor accounts packages.    // 4\n *                                                                                                         // 5\n * @module Roles                                                                                           // 6\n */                                                                                                        // 7\n                                                                                                           // 8\n/**                                                                                                        // 9\n * Roles collection documents consist only of an id and a role name.                                       // 10\n *   ex: { _id:<uuid>, name: \"admin\" }                                                                     // 11\n */                                                                                                        // 12\nif (!Meteor.roles) {                                                                                       // 13\n  Meteor.roles = new Mongo.Collection(\"roles\")                                                             // 14\n}                                                                                                          // 15\n                                                                                                           // 16\n/**                                                                                                        // 17\n * Authorization package compatible with built-in Meteor accounts system.                                  // 18\n *                                                                                                         // 19\n * Stores user's current roles in a 'roles' field on the user object.                                      // 20\n *                                                                                                         // 21\n * @class Roles                                                                                            // 22\n * @constructor                                                                                            // 23\n */                                                                                                        // 24\nif ('undefined' === typeof Roles) {                                                                        // 25\n  Roles = {}                                                                                               // 26\n}                                                                                                          // 27\n                                                                                                           // 28\n\"use strict\";                                                                                              // 29\n                                                                                                           // 30\nvar mixingGroupAndNonGroupErrorMsg = \"Roles error: Can't mix grouped and non-grouped roles for same user\";\n                                                                                                           // 32\n_.extend(Roles, {                                                                                          // 33\n                                                                                                           // 34\n  /**                                                                                                      // 35\n   * Constant used to reference the special 'global' group that                                            // 36\n   * can be used to apply blanket permissions across all groups.                                           // 37\n   *                                                                                                       // 38\n   * @example                                                                                              // 39\n   *     Roles.addUsersToRoles(user, 'admin', Roles.GLOBAL_GROUP)                                          // 40\n   *     Roles.userIsInRole(user, 'admin') // => true                                                      // 41\n   *                                                                                                       // 42\n   *     Roles.setUserRoles(user, 'support-staff', Roles.GLOBAL_GROUP)                                     // 43\n   *     Roles.userIsInRole(user, 'support-staff') // => true                                              // 44\n   *     Roles.userIsInRole(user, 'admin') // => false                                                     // 45\n   *                                                                                                       // 46\n   * @property GLOBAL_GROUP                                                                                // 47\n   * @type String                                                                                          // 48\n   * @static                                                                                               // 49\n   * @final                                                                                                // 50\n   */                                                                                                      // 51\n  GLOBAL_GROUP: '__global_roles__',                                                                        // 52\n                                                                                                           // 53\n                                                                                                           // 54\n  /**                                                                                                      // 55\n   * Create a new role. Whitespace will be trimmed.                                                        // 56\n   *                                                                                                       // 57\n   * @method createRole                                                                                    // 58\n   * @param {String} role Name of role                                                                     // 59\n   * @return {String} id of new role                                                                       // 60\n   */                                                                                                      // 61\n  createRole: function (role) {                                                                            // 62\n    var id,                                                                                                // 63\n        match                                                                                              // 64\n                                                                                                           // 65\n    if (!role                                                                                              // 66\n        || 'string' !== typeof role                                                                        // 67\n        || role.trim().length === 0) {                                                                     // 68\n      return                                                                                               // 69\n    }                                                                                                      // 70\n                                                                                                           // 71\n    try {                                                                                                  // 72\n      id = Meteor.roles.insert({'name': role.trim()})                                                      // 73\n      return id                                                                                            // 74\n    } catch (e) {                                                                                          // 75\n      // (from Meteor accounts-base package, insertUserDoc func)                                           // 76\n      // XXX string parsing sucks, maybe                                                                   // 77\n      // https://jira.mongodb.org/browse/SERVER-3069 will get fixed one day                                // 78\n      if (/E11000 duplicate key error.*(index.*roles|roles.*index).*name/.test(e.err || e.errmsg)) {       // 79\n        throw new Error(\"Role '\" + role.trim() + \"' already exists.\")                                      // 80\n      }                                                                                                    // 81\n      else {                                                                                               // 82\n        throw e                                                                                            // 83\n      }                                                                                                    // 84\n    }                                                                                                      // 85\n  },                                                                                                       // 86\n                                                                                                           // 87\n  /**                                                                                                      // 88\n   * Delete an existing role.  Will throw \"Role in use\" error if any users                                 // 89\n   * are currently assigned to the target role.                                                            // 90\n   *                                                                                                       // 91\n   * @method deleteRole                                                                                    // 92\n   * @param {String} role Name of role                                                                     // 93\n   */                                                                                                      // 94\n  deleteRole: function (role) {                                                                            // 95\n    if (!role) return                                                                                      // 96\n                                                                                                           // 97\n    var foundExistingUser = Meteor.users.findOne(                                                          // 98\n                              {roles: {$in: [role]}},                                                      // 99\n                              {fields: {_id: 1}})                                                          // 100\n                                                                                                           // 101\n    if (foundExistingUser) {                                                                               // 102\n      throw new Meteor.Error(403, 'Role in use')                                                           // 103\n    }                                                                                                      // 104\n                                                                                                           // 105\n    var thisRole = Meteor.roles.findOne({name: role})                                                      // 106\n    if (thisRole) {                                                                                        // 107\n      Meteor.roles.remove({_id: thisRole._id})                                                             // 108\n    }                                                                                                      // 109\n  },                                                                                                       // 110\n                                                                                                           // 111\n  /**                                                                                                      // 112\n   * Add users to roles. Will create roles as needed.                                                      // 113\n   *                                                                                                       // 114\n   * NOTE: Mixing grouped and non-grouped roles for the same user                                          // 115\n   *       is not supported and will throw an error.                                                       // 116\n   *                                                                                                       // 117\n   * Makes 2 calls to database:                                                                            // 118\n   *  1. retrieve list of all existing roles                                                               // 119\n   *  2. update users' roles                                                                               // 120\n   *                                                                                                       // 121\n   * @example                                                                                              // 122\n   *     Roles.addUsersToRoles(userId, 'admin')                                                            // 123\n   *     Roles.addUsersToRoles(userId, ['view-secrets'], 'example.com')                                    // 124\n   *     Roles.addUsersToRoles([user1, user2], ['user','editor'])                                          // 125\n   *     Roles.addUsersToRoles([user1, user2], ['glorious-admin', 'perform-action'], 'example.org')        // 126\n   *     Roles.addUsersToRoles(userId, 'admin', Roles.GLOBAL_GROUP)                                        // 127\n   *                                                                                                       // 128\n   * @method addUsersToRoles                                                                               // 129\n   * @param {Array|String} users User id(s) or object(s) with an _id field                                 // 130\n   * @param {Array|String} roles Name(s) of roles/permissions to add users to                              // 131\n   * @param {String} [group] Optional group name. If supplied, roles will be                               // 132\n   *                         specific to that group.                                                       // 133\n   *                         Group names can not start with a '$' or contain                               // 134\n   *                         null characters.  Periods in names '.' are                                    // 135\n   *                         automatically converted to underscores.                                       // 136\n   *                         The special group Roles.GLOBAL_GROUP provides                                 // 137\n   *                         a convenient way to assign blanket roles/permissions                          // 138\n   *                         across all groups.  The roles/permissions in the                              // 139\n   *                         Roles.GLOBAL_GROUP group will be automatically                                // 140\n   *                         included in checks for any group.                                             // 141\n   */                                                                                                      // 142\n  addUsersToRoles: function (users, roles, group) {                                                        // 143\n    // use Template pattern to update user roles                                                           // 144\n    Roles._updateUserRoles(users, roles, group, Roles._update_$addToSet_fn)                                // 145\n  },                                                                                                       // 146\n                                                                                                           // 147\n  /**                                                                                                      // 148\n   * Set a users roles/permissions.                                                                        // 149\n   *                                                                                                       // 150\n   * @example                                                                                              // 151\n   *     Roles.setUserRoles(userId, 'admin')                                                               // 152\n   *     Roles.setUserRoles(userId, ['view-secrets'], 'example.com')                                       // 153\n   *     Roles.setUserRoles([user1, user2], ['user','editor'])                                             // 154\n   *     Roles.setUserRoles([user1, user2], ['glorious-admin', 'perform-action'], 'example.org')           // 155\n   *     Roles.setUserRoles(userId, 'admin', Roles.GLOBAL_GROUP)                                           // 156\n   *                                                                                                       // 157\n   * @method setUserRoles                                                                                  // 158\n   * @param {Array|String} users User id(s) or object(s) with an _id field                                 // 159\n   * @param {Array|String} roles Name(s) of roles/permissions to add users to                              // 160\n   * @param {String} [group] Optional group name. If supplied, roles will be                               // 161\n   *                         specific to that group.                                                       // 162\n   *                         Group names can not start with '$'.                                           // 163\n   *                         Periods in names '.' are automatically converted                              // 164\n   *                         to underscores.                                                               // 165\n   *                         The special group Roles.GLOBAL_GROUP provides                                 // 166\n   *                         a convenient way to assign blanket roles/permissions                          // 167\n   *                         across all groups.  The roles/permissions in the                              // 168\n   *                         Roles.GLOBAL_GROUP group will be automatically                                // 169\n   *                         included in checks for any group.                                             // 170\n   */                                                                                                      // 171\n  setUserRoles: function (users, roles, group) {                                                           // 172\n    // use Template pattern to update user roles                                                           // 173\n    Roles._updateUserRoles(users, roles, group, Roles._update_$set_fn)                                     // 174\n  },                                                                                                       // 175\n                                                                                                           // 176\n  /**                                                                                                      // 177\n   * Remove users from roles                                                                               // 178\n   *                                                                                                       // 179\n   * @example                                                                                              // 180\n   *     Roles.removeUsersFromRoles(users.bob, 'admin')                                                    // 181\n   *     Roles.removeUsersFromRoles([users.bob, users.joe], ['editor'])                                    // 182\n   *     Roles.removeUsersFromRoles([users.bob, users.joe], ['editor', 'user'])                            // 183\n   *     Roles.removeUsersFromRoles(users.eve, ['user'], 'group1')                                         // 184\n   *                                                                                                       // 185\n   * @method removeUsersFromRoles                                                                          // 186\n   * @param {Array|String} users User id(s) or object(s) with an _id field                                 // 187\n   * @param {Array|String} roles Name(s) of roles to remove users from                                     // 188\n   * @param {String} [group] Optional. Group name. If supplied, only that                                  // 189\n   *                         group will have roles removed.                                                // 190\n   */                                                                                                      // 191\n  removeUsersFromRoles: function (users, roles, group) {                                                   // 192\n    var update                                                                                             // 193\n                                                                                                           // 194\n    if (!users) throw new Error (\"Missing 'users' param\")                                                  // 195\n    if (!roles) throw new Error (\"Missing 'roles' param\")                                                  // 196\n    if (group) {                                                                                           // 197\n      if ('string' !== typeof group)                                                                       // 198\n        throw new Error (\"Roles error: Invalid parameter 'group'. Expected 'string' type\")                 // 199\n      if ('$' === group[0])                                                                                // 200\n        throw new Error (\"Roles error: groups can not start with '$'\")                                     // 201\n                                                                                                           // 202\n      // convert any periods to underscores                                                                // 203\n      group = group.replace(/\\./g, '_')                                                                    // 204\n    }                                                                                                      // 205\n                                                                                                           // 206\n    // ensure arrays                                                                                       // 207\n    if (!_.isArray(users)) users = [users]                                                                 // 208\n    if (!_.isArray(roles)) roles = [roles]                                                                 // 209\n                                                                                                           // 210\n    // ensure users is an array of user ids                                                                // 211\n    users = _.reduce(users, function (memo, user) {                                                        // 212\n      var _id                                                                                              // 213\n      if ('string' === typeof user) {                                                                      // 214\n        memo.push(user)                                                                                    // 215\n      } else if ('object' === typeof user) {                                                               // 216\n        _id = user._id                                                                                     // 217\n        if ('string' === typeof _id) {                                                                     // 218\n          memo.push(_id)                                                                                   // 219\n        }                                                                                                  // 220\n      }                                                                                                    // 221\n      return memo                                                                                          // 222\n    }, [])                                                                                                 // 223\n                                                                                                           // 224\n    // update all users, remove from roles set                                                             // 225\n                                                                                                           // 226\n    if (group) {                                                                                           // 227\n      update = {$pullAll: {}}                                                                              // 228\n      update.$pullAll['roles.'+group] = roles                                                              // 229\n    } else {                                                                                               // 230\n      update = {$pullAll: {roles: roles}}                                                                  // 231\n    }                                                                                                      // 232\n                                                                                                           // 233\n    try {                                                                                                  // 234\n      if (Meteor.isClient) {                                                                               // 235\n        // Iterate over each user to fulfill Meteor's 'one update per ID' policy                           // 236\n        _.each(users, function (user) {                                                                    // 237\n          Meteor.users.update({_id:user}, update)                                                          // 238\n        })                                                                                                 // 239\n      } else {                                                                                             // 240\n        // On the server we can leverage MongoDB's $in operator for performance                            // 241\n        Meteor.users.update({_id:{$in:users}}, update, {multi: true})                                      // 242\n      }                                                                                                    // 243\n    }                                                                                                      // 244\n    catch (ex) {                                                                                           // 245\n      if (ex.name === 'MongoError' && isMongoMixError(ex.err || ex.errmsg)) {                              // 246\n        throw new Error (mixingGroupAndNonGroupErrorMsg)                                                   // 247\n      }                                                                                                    // 248\n                                                                                                           // 249\n      throw ex                                                                                             // 250\n    }                                                                                                      // 251\n  },                                                                                                       // 252\n                                                                                                           // 253\n  /**                                                                                                      // 254\n   * Check if user has specified permissions/roles                                                         // 255\n   *                                                                                                       // 256\n   * @example                                                                                              // 257\n   *     // non-group usage                                                                                // 258\n   *     Roles.userIsInRole(user, 'admin')                                                                 // 259\n   *     Roles.userIsInRole(user, ['admin','editor'])                                                      // 260\n   *     Roles.userIsInRole(userId, 'admin')                                                               // 261\n   *     Roles.userIsInRole(userId, ['admin','editor'])                                                    // 262\n   *                                                                                                       // 263\n   *     // per-group usage                                                                                // 264\n   *     Roles.userIsInRole(user,   ['admin','editor'], 'group1')                                          // 265\n   *     Roles.userIsInRole(userId, ['admin','editor'], 'group1')                                          // 266\n   *     Roles.userIsInRole(userId, ['admin','editor'], Roles.GLOBAL_GROUP)                                // 267\n   *                                                                                                       // 268\n   *     // this format can also be used as short-hand for Roles.GLOBAL_GROUP                              // 269\n   *     Roles.userIsInRole(user, 'admin')                                                                 // 270\n   *                                                                                                       // 271\n   * @method userIsInRole                                                                                  // 272\n   * @param {String|Object} user User Id or actual user object                                             // 273\n   * @param {String|Array} roles Name of role/permission or Array of                                       // 274\n   *                            roles/permissions to check against.  If array,                             // 275\n   *                            will return true if user is in _any_ role.                                 // 276\n   * @param {String} [group] Optional. Name of group.  If supplied, limits check                           // 277\n   *                         to just that group.                                                           // 278\n   *                         The user's Roles.GLOBAL_GROUP will always be checked                          // 279\n   *                         whether group is specified or not.                                            // 280\n   * @return {Boolean} true if user is in _any_ of the target roles                                        // 281\n   */                                                                                                      // 282\n  userIsInRole: function (user, roles, group) {                                                            // 283\n    var id,                                                                                                // 284\n        userRoles,                                                                                         // 285\n        query,                                                                                             // 286\n        groupQuery,                                                                                        // 287\n        found = false                                                                                      // 288\n                                                                                                           // 289\n    // ensure array to simplify code                                                                       // 290\n    if (!_.isArray(roles)) {                                                                               // 291\n      roles = [roles]                                                                                      // 292\n    }                                                                                                      // 293\n                                                                                                           // 294\n    if (!user) return false                                                                                // 295\n    if (group) {                                                                                           // 296\n      if ('string' !== typeof group) return false                                                          // 297\n      if ('$' === group[0]) return false                                                                   // 298\n                                                                                                           // 299\n      // convert any periods to underscores                                                                // 300\n      group = group.replace(/\\./g, '_')                                                                    // 301\n    }                                                                                                      // 302\n                                                                                                           // 303\n    if ('object' === typeof user) {                                                                        // 304\n      userRoles = user.roles                                                                               // 305\n      if (_.isArray(userRoles)) {                                                                          // 306\n        return _.some(roles, function (role) {                                                             // 307\n          return _.contains(userRoles, role)                                                               // 308\n        })                                                                                                 // 309\n      } else if (userRoles && 'object' === typeof userRoles) {                                             // 310\n        // roles field is dictionary of groups                                                             // 311\n        found = _.isArray(userRoles[group]) && _.some(roles, function (role) {                             // 312\n          return _.contains(userRoles[group], role)                                                        // 313\n        })                                                                                                 // 314\n        if (!found) {                                                                                      // 315\n          // not found in regular group or group not specified.                                            // 316\n          // check Roles.GLOBAL_GROUP, if it exists                                                        // 317\n          found = _.isArray(userRoles[Roles.GLOBAL_GROUP]) && _.some(roles, function (role) {              // 318\n            return _.contains(userRoles[Roles.GLOBAL_GROUP], role)                                         // 319\n          })                                                                                               // 320\n        }                                                                                                  // 321\n        return found                                                                                       // 322\n      }                                                                                                    // 323\n                                                                                                           // 324\n      // missing roles field, try going direct via id                                                      // 325\n      id = user._id                                                                                        // 326\n    } else if ('string' === typeof user) {                                                                 // 327\n      id = user                                                                                            // 328\n    }                                                                                                      // 329\n                                                                                                           // 330\n    if (!id) return false                                                                                  // 331\n                                                                                                           // 332\n                                                                                                           // 333\n    query = {_id: id, $or: []}                                                                             // 334\n                                                                                                           // 335\n    // always check Roles.GLOBAL_GROUP                                                                     // 336\n    groupQuery = {}                                                                                        // 337\n    groupQuery['roles.'+Roles.GLOBAL_GROUP] = {$in: roles}                                                 // 338\n    query.$or.push(groupQuery)                                                                             // 339\n                                                                                                           // 340\n    if (group) {                                                                                           // 341\n      // structure of query, when group specified including Roles.GLOBAL_GROUP                             // 342\n      //   {_id: id,                                                                                       // 343\n      //    $or: [                                                                                         // 344\n      //      {'roles.group1':{$in: ['admin']}},                                                           // 345\n      //      {'roles.__global_roles__':{$in: ['admin']}}                                                  // 346\n      //    ]}                                                                                             // 347\n      groupQuery = {}                                                                                      // 348\n      groupQuery['roles.'+group] = {$in: roles}                                                            // 349\n      query.$or.push(groupQuery)                                                                           // 350\n    } else {                                                                                               // 351\n      // structure of query, where group not specified. includes                                           // 352\n      // Roles.GLOBAL_GROUP                                                                                // 353\n      //   {_id: id,                                                                                       // 354\n      //    $or: [                                                                                         // 355\n      //      {roles: {$in: ['admin']}},                                                                   // 356\n      //      {'roles.__global_roles__': {$in: ['admin']}}                                                 // 357\n      //    ]}                                                                                             // 358\n      query.$or.push({roles: {$in: roles}})                                                                // 359\n    }                                                                                                      // 360\n                                                                                                           // 361\n    found = Meteor.users.findOne(query, {fields: {_id: 1}})                                                // 362\n    return found ? true : false                                                                            // 363\n  },                                                                                                       // 364\n                                                                                                           // 365\n  /**                                                                                                      // 366\n   * Retrieve users roles                                                                                  // 367\n   *                                                                                                       // 368\n   * @method getRolesForUser                                                                               // 369\n   * @param {String|Object} user User Id or actual user object                                             // 370\n   * @param {String} [group] Optional name of group to restrict roles to.                                  // 371\n   *                         User's Roles.GLOBAL_GROUP will also be included.                              // 372\n   * @return {Array} Array of user's roles, unsorted.                                                      // 373\n   */                                                                                                      // 374\n  getRolesForUser: function (user, group) {                                                                // 375\n    if (!user) return []                                                                                   // 376\n    if (group) {                                                                                           // 377\n      if ('string' !== typeof group) return []                                                             // 378\n      if ('$' === group[0]) return []                                                                      // 379\n                                                                                                           // 380\n      // convert any periods to underscores                                                                // 381\n      group = group.replace(/\\./g, '_')                                                                    // 382\n    }                                                                                                      // 383\n                                                                                                           // 384\n    if ('string' === typeof user) {                                                                        // 385\n      user = Meteor.users.findOne(                                                                         // 386\n               {_id: user},                                                                                // 387\n               {fields: {roles: 1}})                                                                       // 388\n                                                                                                           // 389\n    } else if ('object' !== typeof user) {                                                                 // 390\n      // invalid user object                                                                               // 391\n      return []                                                                                            // 392\n    }                                                                                                      // 393\n                                                                                                           // 394\n    if (!user || !user.roles) return []                                                                    // 395\n                                                                                                           // 396\n    if (group) {                                                                                           // 397\n      return _.union(user.roles[group] || [], user.roles[Roles.GLOBAL_GROUP] || [])                        // 398\n    }                                                                                                      // 399\n                                                                                                           // 400\n    if (_.isArray(user.roles))                                                                             // 401\n      return user.roles                                                                                    // 402\n                                                                                                           // 403\n    // using groups but group not specified. return global group, if exists                                // 404\n    return user.roles[Roles.GLOBAL_GROUP] || []                                                            // 405\n  },                                                                                                       // 406\n                                                                                                           // 407\n  /**                                                                                                      // 408\n   * Retrieve set of all existing roles                                                                    // 409\n   *                                                                                                       // 410\n   * @method getAllRoles                                                                                   // 411\n   * @return {Cursor} cursor of existing roles                                                             // 412\n   */                                                                                                      // 413\n  getAllRoles: function () {                                                                               // 414\n    return Meteor.roles.find({}, {sort: {name: 1}})                                                        // 415\n  },                                                                                                       // 416\n                                                                                                           // 417\n  /**                                                                                                      // 418\n   * Retrieve all users who are in target role.                                                            // 419\n   *                                                                                                       // 420\n   * NOTE: This is an expensive query; it performs a full collection scan                                  // 421\n   * on the users collection since there is no index set on the 'roles' field.                             // 422\n   * This is by design as most queries will specify an _id so the _id index is                             // 423\n   * used automatically.                                                                                   // 424\n   *                                                                                                       // 425\n   * @method getUsersInRole                                                                                // 426\n   * @param {Array|String} role Name of role/permission.  If array, users                                  // 427\n   *                            returned will have at least one of the roles                               // 428\n   *                            specified but need not have _all_ roles.                                   // 429\n   * @param {String} [group] Optional name of group to restrict roles to.                                  // 430\n   *                         User's Roles.GLOBAL_GROUP will also be checked.                               // 431\n   * @param {Object} [options] Optional options which are passed directly                                  // 432\n   *                           through to `Meteor.users.find(query, options)`                              // 433\n   * @return {Cursor} cursor of users in role                                                              // 434\n   */                                                                                                      // 435\n  getUsersInRole: function (role, group, options) {                                                        // 436\n    var query,                                                                                             // 437\n        roles = role,                                                                                      // 438\n        groupQuery                                                                                         // 439\n                                                                                                           // 440\n    // ensure array to simplify query logic                                                                // 441\n    if (!_.isArray(roles)) roles = [roles]                                                                 // 442\n                                                                                                           // 443\n    if (group) {                                                                                           // 444\n      if ('string' !== typeof group)                                                                       // 445\n        throw new Error (\"Roles error: Invalid parameter 'group'. Expected 'string' type\")                 // 446\n      if ('$' === group[0])                                                                                // 447\n        throw new Error (\"Roles error: groups can not start with '$'\")                                     // 448\n                                                                                                           // 449\n      // convert any periods to underscores                                                                // 450\n      group = group.replace(/\\./g, '_')                                                                    // 451\n    }                                                                                                      // 452\n                                                                                                           // 453\n    query = {$or: []}                                                                                      // 454\n                                                                                                           // 455\n    // always check Roles.GLOBAL_GROUP                                                                     // 456\n    groupQuery = {}                                                                                        // 457\n    groupQuery['roles.'+Roles.GLOBAL_GROUP] = {$in: roles}                                                 // 458\n    query.$or.push(groupQuery)                                                                             // 459\n                                                                                                           // 460\n    if (group) {                                                                                           // 461\n      // structure of query, when group specified including Roles.GLOBAL_GROUP                             // 462\n      //   {                                                                                               // 463\n      //    $or: [                                                                                         // 464\n      //      {'roles.group1':{$in: ['admin']}},                                                           // 465\n      //      {'roles.__global_roles__':{$in: ['admin']}}                                                  // 466\n      //    ]}                                                                                             // 467\n      groupQuery = {}                                                                                      // 468\n      groupQuery['roles.'+group] = {$in: roles}                                                            // 469\n      query.$or.push(groupQuery)                                                                           // 470\n    } else {                                                                                               // 471\n      // structure of query, where group not specified. includes                                           // 472\n      // Roles.GLOBAL_GROUP                                                                                // 473\n      //   {                                                                                               // 474\n      //    $or: [                                                                                         // 475\n      //      {roles: {$in: ['admin']}},                                                                   // 476\n      //      {'roles.__global_roles__': {$in: ['admin']}}                                                 // 477\n      //    ]}                                                                                             // 478\n      query.$or.push({roles: {$in: roles}})                                                                // 479\n    }                                                                                                      // 480\n                                                                                                           // 481\n    return Meteor.users.find(query, options);                                                              // 482\n  },  // end getUsersInRole                                                                                // 483\n                                                                                                           // 484\n  /**                                                                                                      // 485\n   * Retrieve users groups, if any                                                                         // 486\n   *                                                                                                       // 487\n   * @method getGroupsForUser                                                                              // 488\n   * @param {String|Object} user User Id or actual user object                                             // 489\n   * @param {String} [role] Optional name of roles to restrict groups to.                                  // 490\n   *                                                                                                       // 491\n   * @return {Array} Array of user's groups, unsorted. Roles.GLOBAL_GROUP will be omitted                  // 492\n   */                                                                                                      // 493\n  getGroupsForUser: function (user, role) {                                                                // 494\n    var userGroups = [];                                                                                   // 495\n                                                                                                           // 496\n    if (!user) return []                                                                                   // 497\n    if (role) {                                                                                            // 498\n      if ('string' !== typeof role) return []                                                              // 499\n      if ('$' === role[0]) return []                                                                       // 500\n                                                                                                           // 501\n      // convert any periods to underscores                                                                // 502\n      role = role.replace('.', '_')                                                                        // 503\n    }                                                                                                      // 504\n                                                                                                           // 505\n    if ('string' === typeof user) {                                                                        // 506\n      user = Meteor.users.findOne(                                                                         // 507\n               {_id: user},                                                                                // 508\n               {fields: {roles: 1}})                                                                       // 509\n                                                                                                           // 510\n    }else if ('object' !== typeof user) {                                                                  // 511\n      // invalid user object                                                                               // 512\n      return []                                                                                            // 513\n    }                                                                                                      // 514\n                                                                                                           // 515\n    //User has no roles or is not using groups                                                             // 516\n    if (!user || !user.roles || _.isArray(user.roles)) return []                                           // 517\n                                                                                                           // 518\n    if (role) {                                                                                            // 519\n      _.each(user.roles, function(groupRoles, groupName) {                                                 // 520\n        if (_.contains(groupRoles, role) && groupName !== Roles.GLOBAL_GROUP) {                            // 521\n          userGroups.push(groupName);                                                                      // 522\n        }                                                                                                  // 523\n      });                                                                                                  // 524\n      return userGroups;                                                                                   // 525\n    }else {                                                                                                // 526\n      return _.without(_.keys(user.roles), Roles.GLOBAL_GROUP);                                            // 527\n    }                                                                                                      // 528\n                                                                                                           // 529\n  }, //End getGroupsForUser                                                                                // 530\n                                                                                                           // 531\n                                                                                                           // 532\n  /**                                                                                                      // 533\n   * Private function 'template' that uses $set to construct an update object                              // 534\n   * for MongoDB.  Passed to _updateUserRoles                                                              // 535\n   *                                                                                                       // 536\n   * @method _update_$set_fn                                                                               // 537\n   * @protected                                                                                            // 538\n   * @param {Array} roles                                                                                  // 539\n   * @param {String} [group]                                                                               // 540\n   * @return {Object} update object for use in MongoDB update command                                      // 541\n   */                                                                                                      // 542\n  _update_$set_fn: function  (roles, group) {                                                              // 543\n    var update = {}                                                                                        // 544\n                                                                                                           // 545\n    if (group) {                                                                                           // 546\n      // roles is a key/value dict object                                                                  // 547\n      update.$set = {}                                                                                     // 548\n      update.$set['roles.' + group] = roles                                                                // 549\n    } else {                                                                                               // 550\n      // roles is an array of strings                                                                      // 551\n      update.$set = {roles: roles}                                                                         // 552\n    }                                                                                                      // 553\n                                                                                                           // 554\n    return update                                                                                          // 555\n  },  // end _update_$set_fn                                                                               // 556\n                                                                                                           // 557\n  /**                                                                                                      // 558\n   * Private function 'template' that uses $addToSet to construct an update                                // 559\n   * object for MongoDB.  Passed to _updateUserRoles                                                       // 560\n   *                                                                                                       // 561\n   * @method _update_$addToSet_fn                                                                          // 562\n   * @protected                                                                                            // 563\n   * @param {Array} roles                                                                                  // 564\n   * @param {String} [group]                                                                               // 565\n   * @return {Object} update object for use in MongoDB update command                                      // 566\n   */                                                                                                      // 567\n  _update_$addToSet_fn: function (roles, group) {                                                          // 568\n    var update = {}                                                                                        // 569\n                                                                                                           // 570\n    if (group) {                                                                                           // 571\n      // roles is a key/value dict object                                                                  // 572\n      update.$addToSet = {}                                                                                // 573\n      update.$addToSet['roles.' + group] = {$each: roles}                                                  // 574\n    } else {                                                                                               // 575\n      // roles is an array of strings                                                                      // 576\n      update.$addToSet = {roles: {$each: roles}}                                                           // 577\n    }                                                                                                      // 578\n                                                                                                           // 579\n    return update                                                                                          // 580\n  },  // end _update_$addToSet_fn                                                                          // 581\n                                                                                                           // 582\n                                                                                                           // 583\n  /**                                                                                                      // 584\n   * Internal function that uses the Template pattern to adds or sets roles                                // 585\n   * for users.                                                                                            // 586\n   *                                                                                                       // 587\n   * @method _updateUserRoles                                                                              // 588\n   * @protected                                                                                            // 589\n   * @param {Array|String} users user id(s) or object(s) with an _id field                                 // 590\n   * @param {Array|String} roles name(s) of roles/permissions to add users to                              // 591\n   * @param {String} group Group name. If not null or undefined, roles will be                             // 592\n   *                         specific to that group.                                                       // 593\n   *                         Group names can not start with '$'.                                           // 594\n   *                         Periods in names '.' are automatically converted                              // 595\n   *                         to underscores.                                                               // 596\n   *                         The special group Roles.GLOBAL_GROUP provides                                 // 597\n   *                         a convenient way to assign blanket roles/permissions                          // 598\n   *                         across all groups.  The roles/permissions in the                              // 599\n   *                         Roles.GLOBAL_GROUP group will be automatically                                // 600\n   *                         included in checks for any group.                                             // 601\n   * @param {Function} updateFactory Func which returns an update object that                              // 602\n   *                         will be passed to Mongo.                                                      // 603\n   *   @param {Array} roles                                                                                // 604\n   *   @param {String} [group]                                                                             // 605\n   */                                                                                                      // 606\n  _updateUserRoles: function (users, roles, group, updateFactory) {                                        // 607\n    if (!users) throw new Error (\"Missing 'users' param\")                                                  // 608\n    if (!roles) throw new Error (\"Missing 'roles' param\")                                                  // 609\n    if (group) {                                                                                           // 610\n      if ('string' !== typeof group)                                                                       // 611\n        throw new Error (\"Roles error: Invalid parameter 'group'. Expected 'string' type\")                 // 612\n      if ('$' === group[0])                                                                                // 613\n        throw new Error (\"Roles error: groups can not start with '$'\")                                     // 614\n                                                                                                           // 615\n      // convert any periods to underscores                                                                // 616\n      group = group.replace(/\\./g, '_')                                                                    // 617\n    }                                                                                                      // 618\n                                                                                                           // 619\n    var existingRoles,                                                                                     // 620\n        query,                                                                                             // 621\n        update                                                                                             // 622\n                                                                                                           // 623\n    // ensure arrays to simplify code                                                                      // 624\n    if (!_.isArray(users)) users = [users]                                                                 // 625\n    if (!_.isArray(roles)) roles = [roles]                                                                 // 626\n                                                                                                           // 627\n    // remove invalid roles                                                                                // 628\n    roles = _.reduce(roles, function (memo, role) {                                                        // 629\n      if (role                                                                                             // 630\n          && 'string' === typeof role                                                                      // 631\n          && role.trim().length > 0) {                                                                     // 632\n        memo.push(role.trim())                                                                             // 633\n      }                                                                                                    // 634\n      return memo                                                                                          // 635\n    }, [])                                                                                                 // 636\n                                                                                                           // 637\n    // empty roles array is ok, since it might be a $set operation to clear roles                          // 638\n    //if (roles.length === 0) return                                                                       // 639\n                                                                                                           // 640\n    // ensure all roles exist in 'roles' collection                                                        // 641\n    existingRoles = _.reduce(Meteor.roles.find({}).fetch(), function (memo, role) {                        // 642\n      memo[role.name] = true                                                                               // 643\n      return memo                                                                                          // 644\n    }, {})                                                                                                 // 645\n    _.each(roles, function (role) {                                                                        // 646\n      if (!existingRoles[role]) {                                                                          // 647\n        Roles.createRole(role)                                                                             // 648\n      }                                                                                                    // 649\n    })                                                                                                     // 650\n                                                                                                           // 651\n    // ensure users is an array of user ids                                                                // 652\n    users = _.reduce(users, function (memo, user) {                                                        // 653\n      var _id                                                                                              // 654\n      if ('string' === typeof user) {                                                                      // 655\n        memo.push(user)                                                                                    // 656\n      } else if ('object' === typeof user) {                                                               // 657\n        _id = user._id                                                                                     // 658\n        if ('string' === typeof _id) {                                                                     // 659\n          memo.push(_id)                                                                                   // 660\n        }                                                                                                  // 661\n      }                                                                                                    // 662\n      return memo                                                                                          // 663\n    }, [])                                                                                                 // 664\n                                                                                                           // 665\n    // update all users                                                                                    // 666\n    update = updateFactory(roles, group)                                                                   // 667\n                                                                                                           // 668\n    try {                                                                                                  // 669\n      if (Meteor.isClient) {                                                                               // 670\n        // On client, iterate over each user to fulfill Meteor's                                           // 671\n        // 'one update per ID' policy                                                                      // 672\n        _.each(users, function (user) {                                                                    // 673\n          Meteor.users.update({_id: user}, update)                                                         // 674\n        })                                                                                                 // 675\n      } else {                                                                                             // 676\n        // On the server we can use MongoDB's $in operator for                                             // 677\n        // better performance                                                                              // 678\n        Meteor.users.update(                                                                               // 679\n          {_id: {$in: users}},                                                                             // 680\n          update,                                                                                          // 681\n          {multi: true})                                                                                   // 682\n      }                                                                                                    // 683\n    }                                                                                                      // 684\n    catch (ex) {                                                                                           // 685\n      if (ex.name === 'MongoError' && isMongoMixError(ex.err || ex.errmsg)) {                              // 686\n        throw new Error (mixingGroupAndNonGroupErrorMsg)                                                   // 687\n      }                                                                                                    // 688\n                                                                                                           // 689\n      throw ex                                                                                             // 690\n    }                                                                                                      // 691\n  }  // end _updateUserRoles                                                                               // 692\n                                                                                                           // 693\n})  // end _.extend(Roles ...)                                                                             // 694\n                                                                                                           // 695\n                                                                                                           // 696\nfunction isMongoMixError (errorMsg) {                                                                      // 697\n  var expectedMessages = [                                                                                 // 698\n      'Cannot apply $addToSet modifier to non-array',                                                      // 699\n      'Cannot apply $addToSet to a non-array field',                                                       // 700\n      'Can only apply $pullAll to an array',                                                               // 701\n      'Cannot apply $pull/$pullAll modifier to non-array',                                                 // 702\n      \"can't append to array using string field name\",                                                     // 703\n      'to traverse the element'                                                                            // 704\n      ]                                                                                                    // 705\n                                                                                                           // 706\n  return _.some(expectedMessages, function (snippet) {                                                     // 707\n    return strContains(errorMsg, snippet)                                                                  // 708\n  })                                                                                                       // 709\n}                                                                                                          // 710\n                                                                                                           // 711\nfunction strContains (haystack, needle) {                                                                  // 712\n  return -1 !== haystack.indexOf(needle)                                                                   // 713\n}                                                                                                          // 714\n                                                                                                           // 715\n}());                                                                                                      // 716\n                                                                                                           // 717\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                         //\n// packages/alanning_roles/client/debug.js                                                                 //\n//                                                                                                         //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                           //\n\"use strict\"                                                                                               // 1\n                                                                                                           // 2\n                                                                                                           // 3\n////////////////////////////////////////////////////////////                                               // 4\n// Debugging helpers                                                                                       // 5\n//                                                                                                         // 6\n// Run this in your browser console to turn on debugging                                                   // 7\n// for this package:                                                                                       // 8\n//                                                                                                         // 9\n//   localstorage.setItem('Roles.debug', true)                                                             // 10\n//                                                                                                         // 11\n                                                                                                           // 12\nRoles.debug = false                                                                                        // 13\n                                                                                                           // 14\ntry {                                                                                                      // 15\n  if (localStorage) {                                                                                      // 16\n    var temp = localStorage.getItem(\"Roles.debug\")                                                         // 17\n                                                                                                           // 18\n    if ('undefined' !== typeof temp) {                                                                     // 19\n      Roles.debug = !!temp                                                                                 // 20\n    }                                                                                                      // 21\n  }                                                                                                        // 22\n} catch (ex) {                                                                                             // 23\n  // ignore: accessing localStorage when its disabled throws                                               // 24\n  // https://github.com/meteor/meteor/issues/5759                                                          // 25\n}                                                                                                          // 26\n                                                                                                           // 27\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                         //\n// packages/alanning_roles/client/uiHelpers.js                                                             //\n//                                                                                                         //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                           //\n\"use strict\"                                                                                               // 1\n                                                                                                           // 2\n/**                                                                                                        // 3\n * Convenience functions for use on client.                                                                // 4\n *                                                                                                         // 5\n * NOTE: You must restrict user actions on the server-side; any                                            // 6\n * client-side checks are strictly for convenience and must not be                                         // 7\n * trusted.                                                                                                // 8\n *                                                                                                         // 9\n * @module UIHelpers                                                                                       // 10\n */                                                                                                        // 11\n                                                                                                           // 12\n                                                                                                           // 13\n////////////////////////////////////////////////////////////                                               // 14\n// UI helpers                                                                                              // 15\n//                                                                                                         // 16\n// Use a semi-private variable rather than declaring UI                                                    // 17\n// helpers directly so that we can unit test the helpers.                                                  // 18\n// XXX For some reason, the UI helpers are not registered                                                  // 19\n// before the tests run.                                                                                   // 20\n//                                                                                                         // 21\nRoles._uiHelpers = {                                                                                       // 22\n                                                                                                           // 23\n  /**                                                                                                      // 24\n   * UI helper to check if current user is in at least one                                                 // 25\n   * of the target roles.  For use in client-side templates.                                               // 26\n   *                                                                                                       // 27\n   * @example                                                                                              // 28\n   *     {{#if isInRole 'admin'}}                                                                          // 29\n   *     {{/if}}                                                                                           // 30\n   *                                                                                                       // 31\n   *     {{#if isInRole 'editor,user'}}                                                                    // 32\n   *     {{/if}}                                                                                           // 33\n   *                                                                                                       // 34\n   *     {{#if isInRole 'editor,user' 'group1'}}                                                           // 35\n   *     {{/if}}                                                                                           // 36\n   *                                                                                                       // 37\n   * @method isInRole                                                                                      // 38\n   * @param {String} role Name of role or comma-seperated list of roles                                    // 39\n   * @param {String} [group] Optional, name of group to check                                              // 40\n   * @return {Boolean} true if current user is in at least one of the target roles                         // 41\n   * @static                                                                                               // 42\n   * @for UIHelpers                                                                                        // 43\n   */                                                                                                      // 44\n  isInRole: function (role, group) {                                                                       // 45\n    var user = Meteor.user(),                                                                              // 46\n        comma = (role || '').indexOf(','),                                                                 // 47\n        roles                                                                                              // 48\n                                                                                                           // 49\n    if (!user) return false                                                                                // 50\n    if (!Match.test(role, String)) return false                                                            // 51\n                                                                                                           // 52\n    if (comma !== -1) {                                                                                    // 53\n      roles = _.reduce(role.split(','), function (memo, r) {                                               // 54\n        if (!r || !r.trim()) {                                                                             // 55\n          return memo                                                                                      // 56\n        }                                                                                                  // 57\n        memo.push(r.trim())                                                                                // 58\n        return memo                                                                                        // 59\n      }, [])                                                                                               // 60\n    } else {                                                                                               // 61\n      roles = [role]                                                                                       // 62\n    }                                                                                                      // 63\n                                                                                                           // 64\n    if (Match.test(group, String)) {                                                                       // 65\n      return Roles.userIsInRole(user, roles, group)                                                        // 66\n    }                                                                                                      // 67\n                                                                                                           // 68\n    return Roles.userIsInRole(user, roles)                                                                 // 69\n  }                                                                                                        // 70\n}                                                                                                          // 71\n                                                                                                           // 72\n                                                                                                           // 73\n                                                                                                           // 74\n////////////////////////////////////////////////////////////                                               // 75\n// Register UI helpers                                                                                     // 76\n//                                                                                                         // 77\n                                                                                                           // 78\nif (Roles.debug && console.log) {                                                                          // 79\n  console.log(\"[roles] Roles.debug =\", Roles.debug)                                                        // 80\n}                                                                                                          // 81\n                                                                                                           // 82\nif ('undefined' !== typeof Package.blaze &&                                                                // 83\n    'undefined' !== typeof Package.blaze.Blaze &&                                                          // 84\n    'function'  === typeof Package.blaze.Blaze.registerHelper) {                                           // 85\n  _.each(Roles._uiHelpers, function (func, name) {                                                         // 86\n    if (Roles.debug && console.log) {                                                                      // 87\n      console.log(\"[roles] registering Blaze helper '\" + name + \"'\")                                       // 88\n    }                                                                                                      // 89\n    Package.blaze.Blaze.registerHelper(name, func)                                                         // 90\n  })                                                                                                       // 91\n}                                                                                                          // 92\n                                                                                                           // 93\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                         //\n// packages/alanning_roles/client/subscriptions.js                                                         //\n//                                                                                                         //\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                           //\n\"use strict\"                                                                                               // 1\n                                                                                                           // 2\n                                                                                                           // 3\n/**                                                                                                        // 4\n * Subscription handle for the currently logged in user's permissions.                                     // 5\n *                                                                                                         // 6\n * NOTE: The corresponding publish function, `_roles`, depends on                                          // 7\n * `this.userId` so it will automatically re-run when the currently                                        // 8\n * logged-in user changes.                                                                                 // 9\n *                                                                                                         // 10\n * @example                                                                                                // 11\n *                                                                                                         // 12\n *     `Roles.subscription.ready()` // => `true` if user roles have been loaded                            // 13\n *                                                                                                         // 14\n * @property subscription                                                                                  // 15\n * @type Object                                                                                            // 16\n * @for Roles                                                                                              // 17\n */                                                                                                        // 18\n                                                                                                           // 19\nTracker.autorun(function () {                                                                              // 20\n  Roles.subscription = Meteor.subscribe(\"_roles\")                                                          // 21\n})                                                                                                         // 22\n                                                                                                           // 23\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\n(function (pkg, symbols) {\n  for (var s in symbols)\n    (s in pkg) || (pkg[s] = symbols[s]);\n})(Package['alanning:roles'] = {}, {\n  Roles: Roles\n});\n\n})();\n","servePath":"/packages/alanning_roles.js"}]