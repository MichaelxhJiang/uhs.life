{"metadata":{"usedHelpers":[],"marked":[],"modules":{"imports":[],"exports":{"exported":[],"specifiers":[]}}},"options":{"filename":"packages/accounts-base/accounts_reconnect_tests.js","filenameRelative":"packages/accounts-base/accounts_reconnect_tests.js","env":{"development":{"plugins":[]}},"retainLines":false,"highlightCode":true,"suppressDeprecationMessages":false,"presets":[],"plugins":[[[],{"generateLetDeclarations":true,"enforceStrictMode":false}],[[],null],[[],{"polyfill":false}],[[],null],[[],null],[[],null],[[],{"allowTopLevelThis":true,"strict":false,"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],{"loose":true}],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],{"loose":true}],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null],[[],null]],"ignore":[],"code":true,"metadata":true,"ast":true,"comments":true,"compact":false,"minified":false,"sourceMap":true,"sourceMaps":true,"sourceMapTarget":"packages/accounts-base/accounts_reconnect_tests.js.map","sourceFileName":"packages/accounts-base/accounts_reconnect_tests.js","babelrc":false,"sourceType":"module","moduleIds":false,"passPerPreset":false,"parserOpts":false,"generatorOpts":false,"basename":"accounts_reconnect_tests"},"ignored":false,"code":"if (Meteor.isServer) {\n  Meteor.methods({\n    getConnectionUserId: function () {\n      return this.userId;\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  var loginAsUser1 = function (onUser1LoggedIn) {\n    Accounts.createUser({\n      username: \"testuser1-\" + Random.id(),\n      password: \"password1-\" + Random.id()\n    }, onUser1LoggedIn);\n  };\n\n  Tinytest.addAsync('accounts - reconnect auto-login', function (test, done) {\n    var onReconnectCalls = 0;\n\n    var reconnectHandler = function () {\n      onReconnectCalls++;\n    };\n\n    Meteor.connection.onReconnect = reconnectHandler;\n    var username2 = 'testuser2-' + Random.id();\n    var password2 = 'password2-' + Random.id();\n    var timeoutHandle;\n    var onLoginStopper;\n    loginAsUser1(function (err) {\n      test.isUndefined(err, 'Unexpected error logging in as user1');\n      Accounts.createUser({\n        username: username2,\n        password: password2\n      }, onUser2LoggedIn);\n    });\n\n    function onUser2LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user2');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnect);\n      Meteor.disconnect();\n      Meteor.reconnect();\n    }\n\n    function onUser2LoggedInAfterReconnect() {\n      onLoginStopper.stop();\n      Meteor.loginWithPassword('non-existent-user', 'or-wrong-password', onFailedLogin);\n    }\n\n    function onFailedLogin(err) {\n      test.instanceOf(err, Meteor.Error, 'No Meteor.Error on login failure');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnectAfterFailedLogin);\n      Meteor.disconnect();\n      Meteor.reconnect();\n      timeoutHandle = Meteor.setTimeout(failTest, 1000);\n    }\n\n    function failTest() {\n      onLoginStopper.stop();\n      test.fail('Issue #4970 has occured.');\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function onUser2LoggedInAfterReconnectAfterFailedLogin() {\n      onLoginStopper.stop();\n      Meteor.clearTimeout(timeoutHandle);\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function checkFinalState(err, connectionUserId) {\n      test.isUndefined(err, 'Unexpected error calling getConnectionUserId');\n      test.equal(connectionUserId, Meteor.userId(), 'userId is different on client and server');\n      test.equal(Meteor.connection.onReconnect, reconnectHandler, 'Meteor.connection.onReconnect changed');\n      test.equal(onReconnectCalls, 2, 'wrong # of reconnect handler calls');\n      done();\n    }\n  }); // Make sure that when a logged in user is disconnected then reconnected,\n  // they still only have one Accounts login onReconnect callback set.\n  // Addresses: https://github.com/meteor/meteor/issues/9140\n\n  Tinytest.addAsync('accounts - verify single onReconnect callback', function (test, done) {\n    loginAsUser1(function (err) {\n      test.isUndefined(err, 'Unexpected error logging in as user1');\n      test.equal(Object.keys(DDP._reconnectHook.callbacks).length, 1, 'Only one onReconnect callback should be registered');\n      Meteor.disconnect();\n      test.isFalse(Meteor.status().connected);\n      Meteor.reconnect();\n      setTimeout(function () {\n        test.isTrue(Meteor.status().connected);\n        test.equal(Object.keys(DDP._reconnectHook.callbacks).length, 1, 'Only one onReconnect callback should be registered');\n        done();\n      }, 1000);\n    });\n  });\n}","map":{"version":3,"sources":["packages/accounts-base/accounts_reconnect_tests.js"],"names":["Meteor","isServer","methods","getConnectionUserId","userId","isClient","loginAsUser1","onUser1LoggedIn","Accounts","createUser","username","Random","id","password","Tinytest","addAsync","test","done","onReconnectCalls","reconnectHandler","connection","onReconnect","username2","password2","timeoutHandle","onLoginStopper","err","isUndefined","onUser2LoggedIn","onLogin","onUser2LoggedInAfterReconnect","disconnect","reconnect","stop","loginWithPassword","onFailedLogin","instanceOf","Error","onUser2LoggedInAfterReconnectAfterFailedLogin","setTimeout","failTest","fail","call","checkFinalState","clearTimeout","connectionUserId","equal","Object","keys","DDP","_reconnectHook","callbacks","length","isFalse","status","connected","isTrue"],"mappings":"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","file":"packages/accounts-base/accounts_reconnect_tests.js.map","sourcesContent":["if (Meteor.isServer) {\n  Meteor.methods({\n    getConnectionUserId: function() {\n      return this.userId;\n    }\n  });\n}\n\nif (Meteor.isClient) {\n  const loginAsUser1 = (onUser1LoggedIn) => {\n    Accounts.createUser({\n      username: `testuser1-${Random.id()}`,\n      password: `password1-${Random.id()}`\n    }, onUser1LoggedIn);\n  };\n\n  Tinytest.addAsync('accounts - reconnect auto-login', function(test, done) {\n    var onReconnectCalls = 0;\n    var reconnectHandler = function () {\n      onReconnectCalls++;\n    };\n    Meteor.connection.onReconnect = reconnectHandler;\n\n    var username2 = 'testuser2-' + Random.id();\n    var password2 = 'password2-' + Random.id();\n    var timeoutHandle;\n    var onLoginStopper;\n\n    loginAsUser1((err) => {\n      test.isUndefined(err, 'Unexpected error logging in as user1');\n      Accounts.createUser({\n        username: username2,\n        password: password2\n      }, onUser2LoggedIn);\n    });\n\n    function onUser2LoggedIn(err) {\n      test.isUndefined(err, 'Unexpected error logging in as user2');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnect);\n      Meteor.disconnect();\n      Meteor.reconnect();\n    }\n\n    function onUser2LoggedInAfterReconnect() {\n      onLoginStopper.stop();\n      Meteor.loginWithPassword('non-existent-user', 'or-wrong-password',\n        onFailedLogin);\n    }\n\n    function onFailedLogin(err) {\n      test.instanceOf(err, Meteor.Error, 'No Meteor.Error on login failure');\n      onLoginStopper = Accounts.onLogin(onUser2LoggedInAfterReconnectAfterFailedLogin);\n      Meteor.disconnect();\n      Meteor.reconnect();\n      timeoutHandle = Meteor.setTimeout(failTest, 1000);\n    }\n\n    function failTest() {\n      onLoginStopper.stop();\n      test.fail('Issue #4970 has occured.');\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function onUser2LoggedInAfterReconnectAfterFailedLogin() {\n      onLoginStopper.stop();\n      Meteor.clearTimeout(timeoutHandle);\n      Meteor.call('getConnectionUserId', checkFinalState);\n    }\n\n    function checkFinalState(err, connectionUserId) {\n      test.isUndefined(err, 'Unexpected error calling getConnectionUserId');\n      test.equal(connectionUserId, Meteor.userId(),\n        'userId is different on client and server');\n      test.equal(Meteor.connection.onReconnect, reconnectHandler,\n        'Meteor.connection.onReconnect changed');\n      test.equal(onReconnectCalls, 2, 'wrong # of reconnect handler calls');\n      done();\n    }\n  });\n\n  // Make sure that when a logged in user is disconnected then reconnected,\n  // they still only have one Accounts login onReconnect callback set.\n  // Addresses: https://github.com/meteor/meteor/issues/9140\n  Tinytest.addAsync(\n    'accounts - verify single onReconnect callback',\n    function (test, done) {\n      loginAsUser1((err) => {\n        test.isUndefined(err, 'Unexpected error logging in as user1');\n        test.equal(\n          Object.keys(DDP._reconnectHook.callbacks).length,\n          1,\n          'Only one onReconnect callback should be registered'\n        );\n        Meteor.disconnect();\n        test.isFalse(Meteor.status().connected);\n        Meteor.reconnect();\n        setTimeout(() => {\n          test.isTrue(Meteor.status().connected);\n          test.equal(\n            Object.keys(DDP._reconnectHook.callbacks).length,\n            1,\n            'Only one onReconnect callback should be registered'\n          );\n          done();\n        }, 1000);\n      });\n    }\n  );\n}\n"]},"hash":"235de3614d37e381287b7a9823da32850a8c1578"}
